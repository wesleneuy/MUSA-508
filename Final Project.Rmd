---
title: "Final Project"
author: "Me"
date: "12/7/2021"
output: html_document
---
```{r load packages}
library(sf)
library(lubridate)
library(tigris)
library(tidycensus)
library(viridis)
library(riem)
library(gridExtra)
library(knitr)
library(kableExtra)
library(readxl)
library(gganimate)
library(FNN)
library(tidyverse)
library(ggplot2)
library(dplyr)
library(RSocrata)
#library(nngeo)
#install.packages("spatialEco")
#library(spatialEco)
library(sp)
library(jtools)
library(stringr)
library(ggcorrplot)
#library(Hmisc)
#library(car)
library(stargazer)
#library(mlogit)
#library(huxtable)
library(plotROC)
#library(ROCR)
#library(pROC)
library(RSocrata)
library(glue)
library(rjson)
plotTheme <- function(base_size = 12) {
  theme(
    text = element_text( color = "black"),
    plot.title = element_text(size = 14,colour = "black"),
    plot.subtitle = element_text(face="italic"),
    plot.caption = element_text(hjust=0),
    axis.ticks = element_blank(),
    panel.background = element_blank(),
    panel.grid.major = element_line("grey80", size = 0.1),
    panel.grid.minor = element_blank(),
    panel.border = element_blank(),
    strip.background = element_rect(fill = "grey80", color = "white"),
    strip.text = element_text(size=12),
    axis.title = element_text(size=12),
    axis.text = element_text(size=10),
    plot.background = element_blank(),
    legend.background = element_blank(),
    legend.title = element_text(colour = "black", face = "italic"),
    legend.text = element_text(colour = "black", face = "italic"),
    strip.text.x = element_text(size = 14)
  )
}
mapTheme <- function(base_size = 12) {
  theme(
    text = element_text( color = "black"),
    plot.title = element_text(size = 16,colour = "black"),
    plot.subtitle=element_text(face="italic"),
    plot.caption=element_text(hjust=0),
    axis.ticks = element_blank(),
    panel.background = element_blank(),axis.title = element_blank(),
    axis.text = element_blank(),
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_blank(),
    strip.text.x = element_text(size = 14))
}
nn_function <- function(measureFrom,measureTo,k) {
  measureFrom_Matrix <- as.matrix(measureFrom)
  measureTo_Matrix <- as.matrix(measureTo)
  nn <-   
    get.knnx(measureTo, measureFrom, k)$nn.dist
  output <-
    as.data.frame(nn) %>%
    rownames_to_column(var = "thisPoint") %>%
    gather(points, point_distance, V1:ncol(.)) %>%
    arrange(as.numeric(thisPoint)) %>%
    group_by(thisPoint) %>%
    dplyr::summarize(pointDistance = mean(point_distance)) %>%
    arrange(as.numeric(thisPoint)) %>%
    dplyr::select(-thisPoint) %>%
    pull()
  return(output)  
}
```


```{r parking data setup, include=FALSE}
#SF Data 

meter <- read.csv("~/GitHub/MUSA-508/Parking_Meters.csv") 

parking <- read.csv("~/GitHub/MUSA-508/SFMTA_Parking_Meter_Detailed_Revenue_Transactions.csv")

parking2 <- 
  parking %>%
  mutate(interval60 = floor_date(ymd_hms(SESSION_START_DT), unit = "hour"),
         interval15 = floor_date(ymd_hms(SESSION_START_DT), unit = "15 mins"),
         week = week(interval60),
         dotw = wday(interval60, label=TRUE)) 

#get start and end difference, duration for each meter

parking2 <- parking2 %>% mutate(duration = difftime(ymd_hms(SESSION_END_DT), ymd_hms(SESSION_START_DT), unit = "mins"))

#count and average duration by meter
meter_count <- 
  parking2 %>%
   mutate(pk_Counter = 1) %>%
  group_by(POST_ID) %>%
  dplyr::summarize(mean_dur = mean(duration),
                   mean_paid = mean(GROSS_PAID_AMT),
                    pk_Count = sum(pk_Counter, na.rm=T))
#count by block
#block_count <- 
 # parking2 %>%
 # mutate(pk_Counter = 1) %>%
 # group_by(STREET_BLOCK) %>%
 # dplyr::summarize(pk_Count = sum(pk_Counter, na.rm=T))

#merge with parking meter data 
meter_count_info <- merge(x = meter_count, y = meter, by = "POST_ID", all.x=TRUE)

#count and average duration by meter and dotw
meter_count_dotw <- 
  parking2 %>%
  mutate(pk_Counter = 1) %>%
  group_by(POST_ID, dotw) %>%
  dplyr::summarize(mean_dur = mean(duration),
                   mean_paid = mean(GROSS_PAID_AMT),
                   pk_Count = sum(pk_Counter, na.rm=T))


#merge by meter and dotw with parking meter data
meter_count_dotw_info <- merge(x = meter_count_dotw, y = meter, by = "POST_ID", all.x=TRUE)

meter_panel.sf <- st_as_sf(na.omit(meter_count_info), coords = c("LONGITUDE", "LATITUDE"), crs = "+proj=longlat +crs = 'EPSG:6339'", agr = "constant")

meter.sf <- st_as_sf(na.omit(meter), coords = c("LONGITUDE", "LATITUDE"), crs = "+proj=longlat +crs = 'EPSG:6339'", agr = "constant")

meter_panel.sf <- meter_count_info %>% na.omit() %>%
  st_as_sf(coords = c("LONGITUDE", "LATITUDE"), crs = "+proj=longlat +crs = 'EPSG:6339'", agr = "constant") 

meter_dotw_panel.sf <- st_as_sf(na.omit(meter_count_dotw_info), coords = c("LONGITUDE", "LATITUDE"), crs = "+proj=longlat +crs = 'EPSG:6339'")


```

```{r external data setup}
#------------is it an arterial street? ---------------
arterial <- st_read("https://data.sfgov.org/api/geospatial/gnsq-9x5h?method=export&format=GeoJSON") %>%
    mutate(Legend = "streets") %>% select(streetname, geometry, Legend)%>% st_set_crs("+proj=longlat +crs = 'EPSG:6339'")

arterialbuffer <- st_union(st_buffer(arterial, 1))
    st_union(st_buffer(arterial, 1)) %>%
      st_sf()

wildfires <-
 wildfires %>%
 mutate(wildfire = 1)

boulder.sf <-
  st_join(boulder.sf, wildfires) 

boulder.sf$wildfires =
  ifelse(is.na(boulder.sf$wildfire),0, 1)

#------------distance from downtown ------------------
neighborhoods <- st_read("https://data.sfgov.org/api/geospatial/pty2-tcw4?method=export&format=GeoJSON")%>% mutate(Legend = "neighborhoods") %>% st_set_crs("+proj=longlat +crs = 'EPSG:6339'")

#list of neighborhoods

downtown <- c("Downtown / Union Square",
           "Chinatown",
           "Nob Hill",
           "Lower Nob Hill",
           "North Beach",
           "South of Market",
           "Financial District",
           "Civic Center",
           "Mission",
           "Mission Dolores",
           "Mission Bay",
           #"Inner Sunset",
           "Russian Hill")
#just plotting
ggplot() +
  geom_sf(data = downtown, fill = "grey90") +
  geom_sf_label(data = downtown, aes(label = name), size = 3) +
  mapTheme()

#get the union 
downtown <- filter(neighborhoods, name %in% downtown)

downtown_union <- st_union(downtown)
downtown.sf <- st_centroid(downtown_union)


#-----------distance from off street parking----------
garage <- st_read("https://data.sfgov.org/api/geospatial/vqzx-t7c4?method=export&format=GeoJSON") %>% mutate(Legend = "garage") %>% st_set_crs("+proj=longlat +crs = 'EPSG:6339'")

#-----------distance from transit stops---------------
transitstops <- st_read("~/GitHub/MUSA-508/transitstops.geojson") %>% mutate(Legend = "transit") %>% st_set_crs("+proj=longlat +crs = 'EPSG:6339'")

transitstops <- filter(transitstops, agency_id == "SF")

#------------landuse----------------------------------
landuse <- st_read("https://data.sfgov.org/api/geospatial/us3s-fp9q?method=export&format=GeoJSON") %>% st_set_crs("+proj=longlat +crs = 'EPSG:6339'")

retail <- landuse %>% filter(., landuse == "RETAIL/ENT") %>% mutate(Legend = "dum_retail")

cultural <- landuse %>% filter(., landuse == "CIE") %>% mutate(Legend = "dum_culture") 

medical <- landuse %>% filter(., landuse == "MED") %>% mutate(Legend = "dum_med")

visitor <- landuse %>% filter(., landuse == "VISITOR") %>% mutate(Legend = "dum_vis")

#------------count of businesses -----------------------
reg_business <- st_read("https://data.sfgov.org/api/geospatial/g8m3-pdis?method=export&format=GeoJSON") %>%
    mutate(Legend = "business") %>% st_set_crs("+proj=longlat +crs = 'EPSG:6339'") %>% na.omit()

filter(., landuse == "MED") %>% mutate(Legend = "dum_med")
crash_net = 
  dplyr::select(traffic_crash) %>%
  mutate(traffic_crash_count = 1) %>%
  aggregate(., fishnet, sum) %>%
  mutate(traffic_crash_count = replace_na(traffic_crash_count, 0),
         uniqueID = rownames(.),
         cvID = sample(round(nrow(fishnet) / 24), 
                       size=nrow(fishnet), replace = TRUE))
#Arts entertainment and recreation
#Food services
#Retail Trade

#not included
parking_enforcement <- st_read("https://data.sfgov.org/resource/vw6y-z8j6.geojson") %>% filter(., service_name == "Parking Enforcement") %>%
    mutate(Legend = "parking_enforcement") %>% st_set_crs("+proj=longlat +crs = 'EPSG:6339'")

  
```

Nearest neighbors
```{r data setup}
st_c <- st_coordinates
st_coid <- st_centroid

#garage, transit stop, downtown.sf

vars_nn <-
  study_panel.sf %>%
    mutate(
      downtown.nn =
        nn_function(st_c(study_panel.sf), st_c(downtown.sf),1),
      garage.nn =
        nn_function(st_c(study_panel.sf), st_c(garage),3),
      transit.nn =
        nn_function(st_c(study_panel.sf), st_c(transitstops),1)
      )


vars_nn <- vars_nn %>%
  select(POST_ID, dotw, spc_event.nn, reg_business.nn, lights.nn, enforcement.nn, school.nn, college.nn, transitstop.nn, historic_resources.nn, reg_historical.nn, nearby.nn) %>%
  st_transform(crs = "+proj=longlat +crs = 'EPSG:6339'")

vars_dummy <- eve

  study_panel.sf %>%
    mutate(
      pdr = ifelse(st_intersects(study_panel.sf, pdr), 1, 0),
      pdr = ifelse(is.na(pdr)==T, 0, pdr),
      retail = ifelse(st_intersects(study_panel.sf, retail), 1, 0),
      retail = ifelse(is.na(retail)==T, 0, pdr),
      cultural = ifelse(st_intersects(study_panel.sf, cultural), 1, 0),
      cultural = ifelse(is.na(cultural)==T, 0, cultural),
      medical = ifelse(st_intersects(study_panel.sf, medical), 1, 0),
      medical = ifelse(is.na(medical)==T, 0, medical),
      management = ifelse(st_intersects(study_panel.sf, management), 1, 0),
      management = ifelse(is.na(management)==T, 0, management),
      visitor = ifelse(st_intersects(study_panel.sf, visitor), 1, 0),
      visitor = ifelse(is.na(visitor)==T, 0, visitor),
    )

vars_dummy <-
  vars_dummy %>%
  select(POST_ID, dotw, pdr, retail, cultural, medical, management, visitor)

nn_and_dummy <- 
  left_join(as.data.frame(vars_nn), vars_dummy, by=c("POST_ID", "dotw"))
```

```{r census data setup}
census_api_key("7fcf0c60997f4d8ccd298e26df0b2f35dc033150",install=TRUE, overwrite=TRUE)

SFCensus <- 
  get_acs(geography = "tract", 
          variables = c("B01003_001", "B19013_001", 
                        "B02001_002", "B08013_001",
                        "B08012_001", "B08301_001", 
                        "B08301_010", "B01002_001"), 
          year = 2019, 
          state = 06,
          county= 075,
          geometry = TRUE, 
          output = "wide") %>%
  dplyr::rename(Total_Pop =  B01003_001E,
         Med_Inc = B19013_001E,
         Med_Age = B01002_001E,
         White_Pop = B02001_002E,
         Travel_Time = B08013_001E,
         Num_Commuters = B08012_001E,
         Means_of_Transport = B08301_001E,
         Total_Public_Trans = B08301_010E) %>%
  dplyr::select(Total_Pop, Med_Inc, White_Pop, Travel_Time, 
         Means_of_Transport, Total_Public_Trans,
         Med_Age,
         GEOID, geometry) %>%
  mutate(Percent_White = White_Pop / Total_Pop,
         Mean_Commute_Time = Travel_Time / Total_Public_Trans,
         Percent_Taking_Public_Trans = Total_Public_Trans / Means_of_Transport)


SFTracts <-
  SFCensus %>%
  as.data.frame() %>%
  distinct(GEOID, .keep_all = TRUE) %>%
  st_sf %>%
  st_transform(st_crs(6339))
`%nin%` = Negate(`%in%`)
SFTracts <- subset(SFTracts, GEOID %nin% c("06075980401","06075017902","06075017902","06075017902"))


dat_census <- st_join(study_panel.sf,
        SFTracts %>%
          st_transform(crs = "+proj=longlat +crs = 'EPSG:6339'"),
        join=st_intersects,
              left = TRUE) %>%
  rename(Origin.Tract = GEOID) %>%
  mutate(LONGITUDE = unlist(map(geometry, 1)),
         LATITUDE = unlist(map(geometry, 2)))

dat_census <-
  dat_census %>%
  select(POST_ID, dotw, pk_Count, ON_OFFSTREET_TYPE, Neighborhoods, Total_Pop, Med_Inc, White_Pop, Travel_Time, Means_of_Transport, Total_Public_Trans, Med_Age, Percent_White, Mean_Commute_Time, Percent_Taking_Public_Trans, LONGITUDE, LATITUDE)
```

Weather
```{r data setup}
#weather
weather.Panel <- 
  riem_measures(station = "SFO", date_start = "2019-06-01", date_end = "2019-08-31") %>%
  dplyr::select(valid, tmpf, p01i, sknt, vsby)%>% #add visibility in miles
  replace(is.na(.), 0) %>%
    mutate(interval60 = ymd_h(substr(valid,1,13))) %>%
    mutate(week = week(interval60),
           dotw = wday(interval60, label=TRUE)) %>%
    group_by(interval60) %>%
    dplyr::summarize(Temperature = max(tmpf),
              Precipitation = sum(p01i),
              Wind_Speed = max(sknt),
              visibility = max(vsby)) %>%
    mutate(Temperature = ifelse(Temperature == 0, 42, Temperature))
grid.arrange(
  ggplot(weather.Panel, aes(interval60,Precipitation)) + geom_line(color = "#cfe2f3ff", size = 1) + 
  labs(title="Precipitation", x="Hour", y="Precipitation") + plotTheme(),
  ggplot(weather.Panel, aes(interval60,Wind_Speed)) + geom_line(color = "#cfe2f3ff", size = 1) + 
    labs(title="Wind Speed", x="Hour", y="Wind Speed") + plotTheme(),
  ggplot(weather.Panel, aes(interval60,Temperature)) + geom_line(color = "#cfe2f3ff", size = 1) + 
    labs(title="Temperature", x="Hour", y="Temperature") + plotTheme(),
  ggplot(weather.Panel, aes(interval60,Temperature)) + geom_line(color = "#cfe2f3ff", size = 1) + 
    labs(title="Visibility", x="Hour", y="Temperature") + plotTheme(),
  top="Weather Data - San Francisco SFO - Summer 2019")
```

Joining all to one
```{r data setup}
dat_all <- 
  left_join(as.data.frame(dat_census), nn_and_dummy, by=c("POST_ID", "dotw"))

# Parking count per day
dat_all <- dat_all %>%
  mutate(pk_Count = pk_Count/4)
```


```{r data setup}
dat_all$cat_age <- ifelse(dat_all$Med_Age <= 35.9, "1QU", ifelse(dat_all$Med_Age > 35.9 & dat_all$Med_Age <= 37.3, "2QU", ifelse(dat_all$Med_Age > 37.3 & dat_all$Med_Age <= 41.9, "3QU", "4QU"))) #categorize age

dat_all$cat_inc <- ifelse(dat_all$Med_Inc <= 63808, "1QU", ifelse(dat_all$Med_Inc > 63808 & dat_all$Med_Inc <= 98531, "2QU", ifelse(dat_all$Med_Inc > 98531 & dat_all$Med_Inc <= 141588, "3QU", "4QU"))) #categorize income
```

```{r data setup}
#Create time lags
ride.panel <- 
  ride.panel %>% 
  arrange(start_station, interval60) %>% 
  mutate(lagHour = dplyr::lag(Trip_Count,1),
         lag2Hours = dplyr::lag(Trip_Count,2),
         lag3Hours = dplyr::lag(Trip_Count,3),
         lag4Hours = dplyr::lag(Trip_Count,4),
         lag12Hours = dplyr::lag(Trip_Count,12),
         lag1day = dplyr::lag(Trip_Count,24),
         holiday = ifelse(yday(interval60) == 148,1,0)) %>%
  mutate(day = yday(interval60)) 
```


Exploratory plots 
## Distribution of parking posts
```{r data setup}
# count by post per day
ggplot(post_panel.sf, 
       aes(x=(pk_Count/28)))+ 
  geom_histogram(fill = "#cfe2f3ff")+ 
  scale_y_continuous("Frequency") + 
  scale_x_continuous("Count") + 
  labs(caption="Figure X. Histogram of average count by meter per day")

# logged count by post per day
ggplot(post_panel.sf, 
       aes(x=pk_Count/28))+ 
  geom_histogram(fill = "#cfe2f3ff")+ 
  scale_y_continuous("Frequency") + 
  scale_x_log10("Log of Count") + 
  labs(caption="Figure X. Histogram of average log of count by meter per day")
```

## Spatial Distribution
```{r data setup}
post_panel.sf <- post_panel.sf %>%
  mutate(LONGITUDE = unlist(map(geometry, 1)),
         LATITUDE = unlist(map(geometry, 2)))
ggplot()+
  geom_sf(data = SFTracts %>%
            st_transform(crs="+proj=longlat +crs = 'EPSG:6339'"), colour = '#efefef')+
  geom_point(data = post_panel.sf,
             aes(x=LONGITUDE, y = LATITUDE, color = (pk_Count/28)), 
             fill = "transparent",  size = 0.2)+
  scale_colour_viridis(discrete = FALSE, option = "D",
                       name="Average count \nper day")+
  labs(title="Parking Sessions per day by post,\nSan Francisco, July 4 - August 4, 2017",caption = "Figure X") +
  mapTheme()
```

## Exploring Time
```{r data setup}
study.panel.plot <- dat_all %>%
               group_by(POST_ID, dotw, LONGITUDE, LATITUDE) %>%
               tally()
ggplot(study.panel.plot)+
  geom_col(aes(dotw, n/4), fill = "#cfe2f3ff", size = 1.25)+
  labs(title="Average Parking Sessions by Day of Week,\nSan Francisco, July 4 - August 1, 2017",
       x="Day of Week", 
       y="Number of Sessions")+
  plotTheme()
```

```{r data setup}
# plot map by day of the week
ggplot()+
  geom_sf(data = SFTracts %>%
            st_transform(crs="+proj=longlat +crs = 'EPSG:6339'"), colour = '#efefef')+
  geom_point(data = study.panel.plot,
             aes(x=LONGITUDE, y = LATITUDE, color = n/4), 
             fill = "transparent",  size = 1)+
  scale_colour_viridis(discrete = FALSE, option = "D",
                       name="Count")+
  facet_grid(~ dotw)+
  labs(title="Average Parking Sessions Count by Day of Week,\nSan Francisco, July 4 - August 1, 2017") +
  mapTheme()
```

```{r data setup}
ggplot(parkingsample %>% mutate(hour = hour(SESSION_END_DT)))+
  geom_freqpoly(aes(hour, color = dotw), binwidth = 1, size = 1)+
  labs(title="Parking Sessions by Day of the Week,\nSan Francisco, July 4 - August 4, 2017",
       x="Day of the Week", 
       y="Session Counts",caption = "Figure X")+
  plotTheme()
```

```{r data setup}
park_exp.demographic <-
  dat_all %>%
  dplyr::select(pk_Count,
                Total_Pop, Med_Inc, White_Pop, Med_Age,
                Percent_White, 
    -LONGITUDE, -LATITUDE, -geometry, -geometry.x, -geometry.y) %>%
  gather(key,value, -pk_Count)
ggplot(park_exp.demographic, aes(value))+
  geom_bar(stat = "bin", fill="#cfe2f3ff")+
  facet_wrap(~key, scales="free", ncol=3)+
  labs(x="Variable value",y="Count",
       title = "Distribution across variables",
       name="")+
  theme(legend.position="bottom")
ggplot(park_exp.demographic, aes(log(value)))+
  geom_bar(stat = "bin", fill="#cfe2f3ff")+
  facet_wrap(~key, scales="free", ncol=3)+
  labs(x="Log of Variable value",y="Count",
       title = "Distribution across variables, after log transformation",
       name="")+
  theme(legend.position="bottom")
```




```{r data setup}

```

Modeling
Occupancy 30 min prior, 60 min prior, same period previous day, distance from downtown, count of medical offices within 300 meters, count of businesses within 300 meters, count of bars and restaurants within 300 m, count of grocery store and markets 
```{r data setup}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r cars}
summary(cars)
```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
