---
title: "Midterm"
author: "Me"
date: "10/8/2021"
output: html_document
---
#Load Packages
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(tidycensus)
library(sf)
library(spdep)
library(caret)
library(ckanr)
library(FNN)
library(grid)
library(gridExtra)
library(ggcorrplot)
library(kableExtra)
library(jtools)   
library(ggstance) 
library(stargazer)
library(osmdata)
library(tigris)
```

```{r graphic themes, warning = FALSE}
mapTheme <- function(base_size = 12) {
  theme(
    text = element_text( color = "black"),
    plot.title = element_text(size = 16,colour = "black"),
    plot.subtitle=element_text(face="italic"),
    plot.caption=element_text(hjust=0),
    axis.ticks = element_blank(),
    panel.background = element_blank(),axis.title = element_blank(),
    axis.text = element_blank(),
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_rect(colour = "black", fill=NA, size=2),
    strip.text.x = element_text(size = 14))
}

plotTheme <- function(base_size = 12) {
  theme(
    text = element_text( color = "black"),
    plot.title = element_text(size = 16,colour = "black"),
    plot.subtitle = element_text(face="italic"),
    plot.caption = element_text(hjust=0),
    axis.ticks = element_blank(),
    panel.background = element_blank(),
    panel.grid.major = element_line("grey80", size = 0.1),
    panel.grid.minor = element_blank(),
    panel.border = element_rect(colour = "grey80", fill=NA, size=1),
    strip.background = element_rect(fill = "grey80", color = "white"),
    strip.text = element_text(size=12),
    axis.title = element_text(size=12),
    axis.text = element_text(size=10),
    plot.background = element_blank(),
    legend.background = element_blank(),
    legend.title = element_text(colour = "black", face = "italic"),
    legend.text = element_text(colour = "black", face = "italic"),
    strip.text.x = element_text(size = 14)
  )
}

# Load hexadecimal color palette

palette5 <- c("#ffcdb2","#ffb4a2","#e5989b","#b5838d","#6d6875")

# Load Quantile break functions

qBr <- function(df, variable, rnd) {
  if (missing(rnd)) {
    as.character(quantile(round(df[[variable]],0),
                          c(.01,.2,.4,.6,.8), na.rm=T))
  } else if (rnd == FALSE | rnd == F) {
    as.character(formatC(quantile(df[[variable]]), digits = 4),
                 c(.01,.2,.4,.6,.8), na.rm=T)
  }
}

q5 <- function(variable) {as.factor(ntile(variable, 5))}
```

## Introduction
This project aims to 
What makes this a difficult exercise?
Modeling strategy
Summary of results

```{r data sets, warning = FALSE}
#How is the zestimate calculated? https://www.zillow.com/z/zestimate/
muni <- #do we need this layer or do we just use census tracts?
  st_read("~/GitHub/MUSA-508/Municipalities.geojson") %>%
  st_transform('ESRI:102653')

boulderCounty <- 
  st_read("~/GitHub/MUSA-508/Midterm/County_Boundary.geojson") %>%
  st_transform('ESRI:102653')

studentData <- 
  st_read("~/GitHub/MUSA-508/studentData.geojson", crs = 'ESRI:102254') %>%
  st_transform('ESRI:102653')

boulder.sf <- studentData %>%
  st_as_sf(coords = c("Longitude", "Latitude"), crs = 4326, agr = "constant") %>%
  st_transform('ESRI:102653') %>%
  mutate(TotalBathrooms = nbrThreeQtrBaths + nbrFullBaths + nbrHalfBaths) %>%
  rename(Size = TotalFinishedSF, 
         TotalBedrooms = nbrBedRoom, 
         GarageSize = carStorageSF)
```
#Factors influencing home values
#Home prices are based on several factors including...
#location - distance from schools and employment opportunities, restaurants, and other amenities, proximity to highways
#Home size also influences its valuation - usable space(excluding garage). Number of bedrooms and bathrooms are important indicators. The age of the house as well as plumbing etc

# Grab OSM data for Boulder County
```{r Parks, warning=FALSE}

# set bounding box - the maximum x-y extent you are interested in
q0 <- opq(bbox = c("Boulder County")) #bounding box for boulder

# Parks

park <- add_osm_feature(opq = q0, key = 'leisure', value = "park") %>%
  osmdata_sf(.)

park.sf <- st_geometry(park$osm_polygons) %>%
  st_as_sf(crs = 4326, agr = "constant") %>%
  st_transform('ESRI:102286') %>%
  cbind(., park$osm_polygons$name) %>%
  rename(NAME = park.osm_polygons.name, geometry = "x")

## Nearest Neighbor Feature for parks
st_c <- st_coordinates

# Park Centroids
parks_sf_cent <- st_centroid(park.sf)

boulder.sf <-
  boulder.sf  %>% 
    mutate(
      park_nn1 = nn_function(st_c(boulder.sf), st_c(parks_sf_cent), 1),
      park_nn2 = nn_function(st_c(boulder.sf), st_c(parks_sf_cent), 2), 
      park_nn3 = nn_function(st_c(boulder.sf), st_c(parks_sf_cent), 3), 
      park_nn4 = nn_function(st_c(boulder.sf), st_c(parks_sf_cent), 4), 
      park_nn5 = nn_function(st_c(boulder.sf), st_c(parks_sf_cent), 5)) 

```

```{r Schools, warning=FALSE}

# Schools
schools <- 
  st_read("~/GitHub/MUSA-508/Midterm/Schools_Boulder.shp") %>%
  st_transform('ESRI:102653')


## Nearest Neighbor Feature for schools
st_c <- st_coordinates

schools.sf <-
  boulder.sf  %>% 
    mutate(
      schools_nn1 = nn_function(st_c(boulder.sf), st_c(schools), 1),
      schools_nn2 = nn_function(st_c(boulder.sf), st_c(schools), 2), 
      schools_nn3 = nn_function(st_c(boulder.sf), st_c(schools), 3), 
      schools_nn4 = nn_function(st_c(boulder.sf), st_c(schools), 4), 
      schools_nn5 = nn_function(st_c(boulder.sf), st_c(schools), 5)) 

uni <- add_osm_feature(opq = q0, key = 'amenity', value = "university") %>%
  osmdata_sf(.)
uni.sf <- st_geometry(uni$osm_points) %>%
  st_transform(4326) %>%
  st_sf() %>%
  cbind(., uni$osm_points$amenity, ) %>% #cbind is giving me an error, not sure how to fix it: arguments imply differing number of rows: 400, 0.
  rename(NAME = uni.osm_points.amenity)
```

```{r Hospitals, warning=FALSE}

# set bounding box - the maximum x-y extent you are interested in
q0 <- opq(bbox = c("Boulder County")) #bounding box for boulder

# Hospitals
# Amenities - Hospitals + Clinics
hospitals <- add_osm_feature(opq = q0, key = 'amenity', value = "hospital") %>%
  osmdata_sf(.)

hospitals.sf <- st_geometry(hospitals$osm_points) %>%
  st_transform(4326) %>%
  st_sf() %>%
  cbind(., hospitals$osm_points$amenity) %>%
  rename(NAME = hospitals.osm_points.amenity) %>%
  #mutate(NAME = is.na(NAME),"hospital")
  
clinics <- add_osm_feature(opq = q0, key = 'amenity', value = "clinic") %>%
  osmdata_sf(.)

clinics.sf <- st_geometry(clinics$osm_points) %>%
  st_transform(4326) %>%
  st_sf() %>%
  cbind(., clinics$osm_points$amenity) %>%
  rename(NAME = clinics.osm_points.amenity)

healthcare <- rbind(hospitals.sf,clinics.sf)  

healthcare.sf <-
  boulder.sf  %>% 
    mutate(
      healthcare_nn1 = nn_function(st_c(boulder.sf), st_c(healthcare), 1),
      healthcare_nn2 = nn_function(st_c(boulder.sf), st_c(healthcare), 2), 
      healthcare_nn3 = nn_function(st_c(boulder.sf), st_c(healthcare), 3), 
      healthcare_nn4 = nn_function(st_c(boulder.sf), st_c(healthcare), 4), 
      healthcare_nn5 = nn_function(st_c(boulder.sf), st_c(healthcare), 5)) 
```

```{r Restaurants, warning=FALSE}
# Amenities - Restaurant

restaurant <- add_osm_feature(opq = q0, key = 'amenity', value = "restaurant") %>%
  osmdata_sf(.)

restaurant.sf <- st_geometry(restaurant$osm_points) %>%
  st_transform(4326) %>%
  st_sf() %>%
  cbind(., restaurant$osm_points$amenity) %>%
  rename(NAME = restaurant.osm_points.amenity)

restaurant.sf <-
  boulder.sf  %>% 
    mutate(
      healthcare_nn1 = nn_function(st_c(boulder.sf), st_c(restaurant.sf), 1),
      healthcare_nn2 = nn_function(st_c(boulder.sf), st_c(restaurant.sf), 2), 
      healthcare_nn3 = nn_function(st_c(boulder.sf), st_c(restaurant.sf), 3), 
      healthcare_nn4 = nn_function(st_c(boulder.sf), st_c(restaurant.sf), 4), 
      healthcare_nn5 = nn_function(st_c(boulder.sf), st_c(restaurant.sf), 5)) 

# Add the features for Boulder County
# You can use this to clip things if it's necessary

coCounties <- counties(state = 'CO', cb = FALSE)

boulder <- coCounties %>%
  filter(NAME == "Boulder") %>%
  st_as_sf() %>%
  st_transform(4326)

# Map it

ggplot()+
  geom_sf(data = boulder, color = "black")+
  scale_color_manual(values = c("orange", "blue"))+
  geom_sf(data = park.sf, fill = "light green", color = "transparent")+
  geom_sf(data = restaurant.sf, color = "red", size = 0.2, alpha = 0.2)
```

```{r wildfire, echo=FALSE}
#Grab wildfire
openspace <- 
  st_read("~/GitHub/MUSA-508/County_Open_Space.geojson") %>%
  filter(!is.na(PARK_GROUP)) %>%
  st_transform('ESRI:102653')
```

```{r road, echo=FALSE}
#Grab road data set
roads <-
  st_read("https://opendata.arcgis.com/datasets/f8292cbf379e4df7b9b8f62e21120ea7_0.geojson")%%
  st_transform('ESRI:102653') %>%
  filter(SPECIFIC_CATEGORY %in% c("State", "Municipal Primary"))
```

```{r pressure, echo=FALSE}
#Grab open space data set
openspace <- 
  st_read("~/GitHub/MUSA-508/County_Open_Space.geojson") %>%
  filter(!is.na(PARK_GROUP)) %>%
  st_transform('ESRI:102653')
```

### Mapping the dependent variable: price

The following map shows home prices spatially distributed across Boulder County.
```{r Price Map, echo=FALSE, message=FALSE, warning=FALSE}
ggplot() +
  geom_sf(data = boulderCounty, fill = "grey90") +
  geom_sf(data = muni, fill = NA) +
  geom_sf(data = boulder.sf, aes(colour = q5(price)), 
          show.legend = "point", size = .5) +
  scale_color_manual(values = palette5,
                   labels = qBr(boulder.sf, "price"),
                   name = "Quintile\nBreaks") +
  #geom_sf_text(data = muni, aes(text = rownames(ZONEDESC)), size = 2) +
  labs(title="Gross Home Prices in Boulder County") +
  mapTheme()
```

### Mapping the independent variables
```{Independent Variables Map, echo=FALSE, message=FALSE, warning=FALSE}
#studentdata - plot points
ggplot() + 
  geom_sf(data=st_union(boulderCounty)) +
  geom_sf(data=muni, show.legend = "point", size= 2) +
 # scale_colour_manual(values = c("orange","blue")) +
  labs(title="Homes", subtitle="Boulder County") +
  mapTheme()

#Parks
ggplot() + 
  geom_sf(data=st_union(boulderCounty)) +
  geom_sf(data=openspace, show.legend = "point", size= 2) +
 # scale_colour_manual(values = c("orange","blue")) +
  labs(title="Parks", subtitle="Boulder County") +
  mapTheme()

#Schools
ggplot() + 
  geom_sf(data=st_union(boulderCounty)) +
  geom_sf(data=schools, show.legend = "point", size= 2) +
 # scale_colour_manual(values = c("orange","blue")) +
  labs(title="Open Space", subtitle="Boulder County") +
  mapTheme()

#Restaurants
ggplot() + 
  geom_sf(data=st_union(boulderCounty)) +
  geom_sf(data=restaurant, show.legend = "point", size= 2) +
 # scale_colour_manual(values = c("orange","blue")) +
  labs(title="Restaurants", subtitle="Boulder County") +
  mapTheme()

#Healthcare
ggplot() + 
  geom_sf(data=st_union(boulderCounty)) +
  geom_sf(data=healthcare, show.legend = "point", size= 2) +
 # scale_colour_manual(values = c("orange","blue")) +
  labs(title="Healthcare", subtitle="Boulder County") +
  mapTheme()
```

#Including demographic variables
```{r Census Data, warning=FALSE}

census_api_key("7fcf0c60997f4d8ccd298e26df0b2f35dc033150",install=TRUE, overwrite=TRUE)
acs_variable_list.2019 <- load_variables(2019, "acs5")

#Year 2019 tracts
tracts19 <- 
  tracts19 %>%
  select( -NAME, -moe) %>%
  spread(variable, estimate) %>%
  select(-geometry) %>%
  rename(TotalPop = B25026_001, 
         MedHHInc = B19013_001, 
         )

#tracts19 <- 
  #tracts19 %>%
  #mutate(pctWhite = ifelse(TotalPop > 0, WhitePop / TotalPop, 0),
   #            pctBachelors = ifelse(TotalPop > 0, ((FemaleBachelors + MaleBachelors) / TotalPop), 0),
    #           year = "2019") %>%
  #select(-WhitePop,-FemaleBachelors,-MaleBachelors)

#Mapping  
ggplot(tracts19)+
  geom_sf(data = st_union(tracts10))+
  geom_sf(aes(fill = q5(TotalPop))) +
  geom_sf(data = buffer, fill = "transparent", color = "red")+
  scale_fill_manual(values = palette5,
                    labels = qBr(allTracts.group, "TotalPop"),
                    name = "Population\n(Quintile Breaks)") +
  labs(title = "Population 2010-2017", subtitle = "Atlanta, GA") +
  facet_wrap(~year)+
  mapTheme() +
  theme(plot.title = element_text(size=22))
                                         
```

## Exploratory Analysis: Correlation Plots

```{r correlation pt 1 echo=FALSE, message=FALSE, warning=FALSE}

#ggplot(filter(boulder.sf, price <= 2000000), aes(y=price, x = GarageSize), show.legend = "point", size = .5) +
#  geom_point(size = .5) +
 # geom_smooth(method = "lm") +
  #labs(title = "Price as a function of Size", y = "Price") +
  #plotTheme()

#Home Characteristics Corr Plots
st_drop_geometry(boulder.sf) %>% 
  mutate(Age = 2015 - builtYear) %>%
  dplyr::select(price, Size, Age, TotalBedrooms, GarageSize) %>%
  filter(price <= 1000000, Age < 500) %>%
  gather(Variable, Value, -price) %>% 
  ggplot(aes(Value, price)) +
     geom_point(size = .5) + geom_smooth(method = "lm", se=F, colour = "#FA7800") +
     facet_wrap(~Variable, ncol = 4, scales = "free") +
     labs(title = "Price as a function of continuous variables") +
     plotTheme()
```
```{r correlation pt. 2 echo=FALSE, message=FALSE, warning=FALSE}

st_drop_geometry(boulder.sf) %>% 
  mutate(Age = 2015 - builtYear) %>%
  dplyr::select(price, Age, TotalBathrooms, mainfloorSF, Ac) %>%
  filter(price <= 1000000, Age < 500) %>%
  gather(Variable, Value, -price, -Age) %>% 
  ggplot(aes(Value, price)) +
     geom_point(size = .5) + geom_smooth(method = "lm", se=F, colour = "#FA7800") +
     facet_wrap(~Variable, ncol = 4, scales = "free") +
     labs(title = "Price as a function of continuous variables") +
     plotTheme()
```

### Correlation to Categorical Variables

Price as a function of non numeric variables

```{r}

st_drop_geometry(boulder.sf) %>% 
  dplyr::select(price, designCodeDscr, ConstCodeDscr, IntWallDscr) %>%
  filter(price <= 1000000) %>%
  gather(Variable, Value, -price) %>% 
   ggplot(aes(Value, price)) +
     geom_bar(position = "dodge", stat = "summary", fun.y = "mean", scientific = FALSE) +
     facet_wrap(~Variable, ncol = 3, scales = "free") +
     labs(title = "Price as a function of categorical variables", y = "Mean_Price") +
     plotTheme() + theme(axis.text.x = element_text(angle = 90, hjust = 1))

```
### Regressions for determining correlation strength

Internal characteristics of homes
```{r}
reg1 <- lm(price ~ Size, data = boulder.sf)

#Table 1 Kable-Tidy
lm(price ~ Size, data = boulder.sf) %>%
  tidy() %>%
  mutate(p.value = scales::pvalue(p.value))%>%
  kable(
    caption = "Coefficient-Level Estimates for a Model Fitted to Predict Home Prices in 
    Boulder County", 
    col.names = c("Predictor", "Estimate", "Std.Err", "t-stat", "p-value"), 
    digits = c(0, 2, 3, 2, 3),
    align = c("l", "r", "r", "r", "r")
  ) %>%
  kable_styling()
    
summary(reg1)


#Table 1 (Stargazer)
stargazer(reg1, type = "html", 
          dep.var.labels=c("Price total"),
          covariate.labels=c("Size in sqm"))

```

```{r}
head(boulder.sf)

reg2 <- lm(price ~ ., data = st_drop_geometry(boulder.sf) %>% 
                                 dplyr::select(price, Size, builtYear, GarageSize,
                                               mainfloorSF, TotalBedrooms, 
                                               TotalBathrooms))
summary(reg2)



reg3 <- lm(price ~ ., data = st_drop_geometry(boulder.sf) %>% 
                                 dplyr::select(price, Size, builtYear, 
                                               TotalBedrooms, TotalBathrooms, 
                                               bsmtSF, park_nn1, park_nn2))
summary(reg3)

#Coefficients of all models
plot_summs(reg1, reg3, reg2)

```




```{r}
#Parks Correlation

boulder.sf %>%
  st_drop_geometry() %>%
  mutate(Age = 2015 - builtYear) %>%
  dplyr::select(price, starts_with("parks_")) %>%
  filter(price <= 1000000) %>%
  gather(Variable, Value, -price) %>% 
   ggplot(aes(Value, price)) +
     geom_point(size = .5) + geom_smooth(method = "lm", se=F, colour = "#FA7800") +
     facet_wrap(~Variable, nrow = 1, scales = "free") +
     labs(title = "Price as a function of continuous variables: Nearest Parks") +
     plotTheme()


```


## Correlation Matrix

```{r message=FALSE, warning=FALSE, paged.print=FALSE, echo=FALSE}

numericVars <- 
  select_if(st_drop_geometry(boulder.sf), is.numeric) %>% na.omit()


ggcorrplot(
  round(cor(numericVars), 1), 
  p.mat = cor_pmat(numericVars),
  show.diag = TRUE,
  colors = c("#25CB10", "white", "#FA7800"),
  type="lower",
  insig = "blank") +  
    labs(title = "Correlation across numeric variables")

```

#Training Model
```{r message=FALSE, warning=FALSE, paged.print=FALSE, echo=FALSE}
inTrain <- createDataPartition(
              y = paste(boulder.sf$Size, boulder.sf$builtYear, boulder.sf$TotalBedrooms), 
              p = .75, list = FALSE)

boulder.training <- boulder.sf[inTrain,] 
boulder.test <- boulder.sf[-inTrain,]  

reg.training <- lm(price ~ ., data = st_drop_geometry(boulder.training) %>% 
                                    dplyr::select(price, Size, builtYear, TotalBedrooms,                                                   TotalBathrooms, bsmtSF, park_nn1,                                                      park_nn2))

boulder.test <-
  boulder.test %>%
  mutate(price.Predict = predict(reg.training, boulder.test),
         price.Error = price.Predict - price,
         price.AbsError = abs(price.Predict - price),
         price.APE = (abs(price.Predict - price)) / price.Predict)%>%
  filter(price < 5000000)

#MAE
mean(boulder.test$price.AbsError, na.rm = T)

#MAPE
mean(boulder.test$price.APE, na.rm = T)

#Generalizability
```

#Discussion: Is this an effective model? What were some of the more interesting variables?
#How much of the variation in prices could you predict? Describe the more important features?
#Describe the error in your predictions? According to your maps, could you account the spatial
#variation in prices? Where did the model predict particularly well? Poorly? Why do you think this
#might be?

#Conclusion: Would you recommend your model to Zillow? Why or why not? How might you
#improve this model?
#Including indicators such as sale prices of recently sold homes, information on upgrades and home improvements, local market conditions, and interest rates. 